[#ftl]
[#import "backgrounds.ftl" as backgrounds]

[#assign layers={
    "Grid-10km" :   {"resolution": 1, "fillColour": "255 255 0"  },
    "Grid-2km"  :   {"resolution": 2, "fillColour": "0 255 0"    },
    "Grid-1km"  :   {"resolution": 3, "fillColour": "0 255 255"  },
    "Grid-100m" :   {"resolution": 4, "fillColour": "255 0 0"    }
}]

[#assign union_layers={
    "Grid-10km-2km" : ["Grid-10km", "Grid-2km"],
    "Grid-10km-1km" : ["Grid-10km", "Grid-2km", "Grid-1km"],
    "Grid-10km-100m": ["Grid-10km", "Grid-2km", "Grid-1km", "Grid-100m"],
    "Grid-2km-1km"  : ["Grid-2km", "Grid-1km"],
    "Grid-2km-100m" : ["Grid-2km", "Grid-1km", "Grid-100m"],
    "Grid-1km-100m" : ["Grid-1km", "Grid-100m"]
}]

[#macro join list separator=","][#list list as element]${element}[#if element_has_next]${separator}[/#if][/#list][/#macro]
MAP
    IMAGETYPE                                             PNG
    SIZE                                                  2800 2800
    IMAGECOLOR                                            255 255 255
    FONTSET                                               "fonts/fontset"
    EXTENT                                                -180 -90 180 90

    WEB
        IMAGEPATH                                           "/ms4w/tmp/ms_tmp/"
        IMAGEURL                                            "/ms_tmp/"
        METADATA
            "wms_title"                                       "Single Species Map"
            "wms_onlineresource"                              "${mapServiceURL}"
            "wms_srs"                                         "EPSG:29903 EPSG:27700 EPSG:4326 EPSG:3857"
            "wms_enable_request"                              "*"
        END
    END

    PROJECTION
        "init=epsg:4326"
    END
    
    [@backgrounds.os location=properties.ordnanceSurveyMapDataLocation requires=union_layers?keys + layers?keys/]
    
    [#if featureID??]
        [@backgrounds.selectedFeature featureID=featureID/]
    [/#if]

    [#list union_layers?keys as union_layer_name]
        LAYER
            NAME "${union_layer_name}"
            TYPE POLYGON
            STATUS ON
            CONNECTIONTYPE UNION
            CONNECTION "[@join union_layers[union_layer_name]/]"
            STYLEITEM "AUTO"
            EXTENT                                                -180 -90 180 90

            # Define an empty class that will be filled at runtime from the color and
            # styles read from each source layer.


            PROJECTION
                "init=epsg:4326"
            END

            METADATA
                "wms_title"                                       "${union_layer_name}"
                "wms_include_items"                               "all"
            END

            [#list union_layers[union_layer_name] as style_layer]
                CLASS
                    NAME                                              "${style_layer} std"
                    STYLE
                        COLOR                                           ${layers[style_layer].fillColour}
                        OUTLINECOLOR                                    0 0 0
                        WIDTH                                           0.5
                    END
                END
            [/#list]
        END
    [/#list]

    [#list layers?keys as layer_name]
        LAYER
            NAME                                                "${layer_name}"
            TYPE                                                POLYGON
            STATUS                                              OFF
            CONNECTIONTYPE                                      PLUGIN
            PLUGIN                                              "msplugin_mssql2008.dll"
            CONNECTION                                          "${properties.spatialConnection}"
            DATA                                                "${layerGenerator.getData(layers[layer_name].resolution)}"
            TEMPLATE                                            "dummy.txt"
            EXTENT                                              -180 -90 180 90

            METADATA
                "wms_title"                                       "${layer_name}"
                "wms_include_items"                               "all"
            END

            PROJECTION
                "init=epsg:4326"
            END

            CLASS
                NAME                                              "${layer_name} std"
                STYLE
                    COLOR                                           ${layers[layer_name].fillColour}
                    OUTLINECOLOR                                    0 0 0
                    WIDTH                                           0.5
                END
            END
        END
    [/#list]
END