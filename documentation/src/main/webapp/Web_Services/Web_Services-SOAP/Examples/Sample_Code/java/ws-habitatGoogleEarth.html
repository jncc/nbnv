<html>
<head>
  <title>Visualisation of Habitat Data</title>
  <script src="http://www.google.com/jsapi?key=ABQIAAAAQPUJ3_nfRftf7A9II29bohT89JljudcViH9jjr44Ty1F8eVwqRQX-JmtcinijaJDyA-5v1r14P8JAA"></script>
  <script type="text/javascript">
  var ge = null;
  
  // store the object loaded for the given file... initially none of the objects
  // are loaded, so initialize these to null
  var currentKmlObjects = {
    'HL000001': null,
    'HL000002': null,
    'HL000005': null,
	'HL000007': null
  };
  
  google.load("earth", "1");

  function init() {
    google.earth.createInstance('map3d', initCB, failureCB);
  }
  
  function initCB(instance) {
    ge = instance;
    ge.getWindow().setVisibility(true);
    
    // add a navigation control
    ge.getNavigationControl().setVisibility(ge.VISIBILITY_AUTO);
    
    // add some layers
    ge.getLayerRoot().enableLayerById(ge.LAYER_BORDERS, true);
    ge.getLayerRoot().enableLayerById(ge.LAYER_ROADS, true);

    // fly to query point
    var la = ge.createLookAt('');
    la.set(53.485301,-1.906836,
      0, // altitude
      ge.ALTITUDE_RELATIVE_TO_GROUND,
      7, // heading
      62, // straight-down tilt
      2701 // range (inverse of zoom)
      );
    ge.getView().setAbstractView(la);
  }
  
  function failureCB(errorCode) {
  }
  
  function toggleKml(file) {
    // remove the old KML object if it exists
    if (currentKmlObjects[file]) {
      ge.getFeatures().removeChild(currentKmlObjects[file]);
      currentKmlObject = null;
    }
    
    // if the checkbox is checked, fetch the KML and show it on Earth
    var kmlCheckbox = document.getElementById('kml-' + file + '-check');
    if (kmlCheckbox.checked)
      loadKml(file);
  }
  
  function loadKml(file) {
    var kmlUrl = 'http://www.testnbn.net/nbnexamples/kml/' + file + '.kml';
  
    // fetch the KML
    google.earth.fetchKml(ge, kmlUrl, function(kmlObject) {    
      if (kmlObject) {
        // show it on Earth
        currentKmlObjects[file] = kmlObject;
        ge.getFeatures().appendChild(kmlObject);
      } else {
        // bad KML
        currentKmlObjects[file] = null;
  
        // wrap alerts in API callbacks and event handlers
        // in a setTimeout to prevent deadlock in some browsers
        setTimeout(function() {
          alert('Bad or null KML.');
        }, 0);
        
        // uncheck the box
        document.getElementById('kml-' + file + '-check').checked = '';
      }
    });
  }
  </script>
</head>
<body onload='init()'>
  <h1>Habitat Data inside a Google Earth Plug-in</h1>
  
  <div id="ui" style="position: relative;">
    <div id="map3d" style="border: 1px solid silver; width: 500px; height: 500px;"></div>

    <div id="extra-ui" style="position: absolute; left: 520px; top: 0;">
		<h2>Toggle KML Files:</h2>
		<p>This page demonstrates what can be done with the spatial web services.
			In this example, a query has executed on the Habitat Web service.
			
			The query was of type buffer around the points 53.657661N, 1.82676W (WGS84). The result of the query has been converted to four KML files One for each layer).
			
			Once in KML form, the results can be loaded into the Google Earth application. In this case they are shown in a Google Earth browser plug-in.
			
			Click the check boxes to enable or disable the visualisation of a particular habitat layer.
		</p>
		
		<p>
			Since the polygons have been visualised inside a Google earth plug-in, it is possible to use their navigation tools to move around the data.
		</p>
		<div>
			<input type="checkbox" id="kml-HL000001-check" onclick="toggleKml('HL000001');"/>
			<label for="kml-HL000001-check">Lowland Grassland BAP Priority Habitat - England v2.01</label>
		</div>
		
		<div>
			<input type="checkbox" id="kml-HL000002-check" onclick="toggleKml('HL000002');"/>
			<label for="kml-HL000002-check">Blanket Bog BAP Priority Habitat - England v2.1</label>
		</div>
		
		<div>
			<input type="checkbox" id="kml-HL000005-check" onclick="toggleKml('HL000005');"/>
			<label for="kml-HL000005-check">Woodland BAP priority habitat - England v2.0</label>
		</div>
		
		<div>
			<input type="checkbox" id="kml-HL000007-check" onclick="toggleKml('HL000007');"/>
			<label for="kml-HL000007-check">Upland Heathland BAP Priority Habitat - England v2.1</label>
		</div>
      </div>
</body>
</html>
